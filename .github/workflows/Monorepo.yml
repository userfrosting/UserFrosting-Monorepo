name: Monorepo Split

on:
  push:
    branches: ['*']
    tags: ['*']
  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}

jobs:
    packages_split:
        runs-on: ubuntu-latest
        name: Split Monorepo - ${{ matrix.package.name }}

        strategy:
            fail-fast: false
            matrix:
                package:
                    - name: "Framework"
                      local_path: "packages/framework"
                      split_repository: "framework"
                      branch: "6.0"
                    - name: "Skeleton"
                      local_path: "packages/skeleton"
                      split_repository: "UserFrosting"
                      branch: "6.0"
                    - name: "Sprinkle Account"
                      local_path: "packages/sprinkle-account"
                      split_repository: "sprinkle-account"
                      branch: "6.0"
                    - name: "Sprinkle Admin"
                      local_path: "packages/sprinkle-admin"
                      split_repository: "sprinkle-admin"
                      branch: "6.0"
                    - name: "Sprinkle Core"
                      local_path: "packages/sprinkle-core"
                      split_repository: "sprinkle-core"
                      branch: "6.0"
                    - name: "Pink Cupcake"
                      local_path: "packages/theme-pink-cupcake"
                      split_repository: "theme-pink-cupcake"
                      branch: "main"

        steps:
            - uses: actions/checkout@v2

            # no tag
            - if: "!startsWith(github.ref, 'refs/tags/')"
              uses: "danharrin/monorepo-split-github-action@v2.3.0"
              with:
                  package_directory: "${{ matrix.package.local_path }}"
                  repository_organization: "userfrosting"
                  repository_name: "${{ matrix.package.split_repository }}"
                  user_name: "UserFrosting Bot"
                  user_email: "no-reply@userfrosting.com"
                  branch: "${{ matrix.package.branch }}"

            # with tag
            - if: "startsWith(github.ref, 'refs/tags/')"
              uses: "danharrin/monorepo-split-github-action@v2.3.0"
              with:
                  tag: ${GITHUB_REF#refs/tags/}
                  package_directory: "${{ matrix.package.local_path }}"
                  repository_organization: "userfrosting"
                  repository_name: "${{ matrix.package.split_repository }}"
                  user_name: "UserFrosting Bot"
                  user_email: "no-reply@userfrosting.com"
                  branch: "${{ matrix.package.branch }}"